Summary:
Major compactions from shell may not major compact all families
Description:
As part of a data center migration, I initiated a major_compaction request on all tables from the shell. A few hours later, all the region servers in the cluster appeared to have completed the compactions and all compactionQueue metrics were back to 0. However, some column families of some regions had not actually done a major compaction.
Digging through logs and code, it looks like the following happened. The shell makes a major compaction request which sets HRegion.forceMajorCompaction to true for every region. Periodically, the HRegionServer.MajorCompactionChecker checks to see if a major compaction is needed in any family's store. If so, calls CompactSplitThread.compactionRequested which ends up setting the region forceMajorCompaction to false, even if it is already in the compaction queue and set to true. Then, when that region comes off the queue to be compacted, each family/store separately checks for whether it should do a major compaction, so some families may not do so.
(This is not good if, for example, you're doing a DistCp of the hbase dir and later on the cluster decides to do a compaction on those files and deletes ones the DistCp job is looking for, causing it to fail.)
Status:
CLOSED
Priority:
Critical
Resolution:
Duplicate
Affects_version:
0.20.4
Fix_version:
0.92.0
Component:
None
Label:
None
Environment:

Attachment number:
0
Assignee:
Unassigned
Reporter:
Dave Latham
Create date:
22/Jun/10 22:03
Update date:
20/Nov/15 12:42
Resolved date:
05/Jul/11 17:19
